<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>12 Delegating authentication to OAuth providers 1.5.4</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/introduction.html"><strong>1</strong><span>Introduction to the Spring Security REST plugin</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/whatsNew15.html"><strong>2</strong><span>What's new in 1.5?</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/whatsNew14.html"><strong>3</strong><span>What's new in 1.4?</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/configuration.html"><strong>4</strong><span>Configuration</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/events.html"><strong>5</strong><span>Events</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/authentication.html"><strong>6</strong><span>Authentication Endpoint</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/tokenGeneration.html"><strong>7</strong><span>Token Generation</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/tokenStorage.html"><strong>8</strong><span>Token Storage</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/tokenRendering.html"><strong>9</strong><span>Token Rendering</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/tokenValidation.html"><strong>10</strong><span>Token Validation Filter</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/cors.html"><strong>11</strong><span>CORS support</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/oauth.html"><strong>12</strong><span>Delegating authentication to OAuth providers</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/debugging.html"><strong>13</strong><span>Debugging</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/faq.html"><strong>14</strong><span>Frequently Asked Questions</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        
    </div>
    <p>Implements authentication for REST APIs based on Spring Security. It uses a token-based workflow</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/cors.html">&lt;&lt; <strong>11</strong><span>CORS support</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/debugging.html"><strong>13</strong><span>Debugging</span> >></a></div>
                


                <div class="project">
                    <h1>12 Delegating authentication to OAuth providers - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Alvaro Sanchez-Mariscal</p>

                    <p><strong>Version:</strong> 1.5.4</p>

                    
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#google"><strong>12.1</strong><span>Google</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#facebook"><strong>12.2</strong><span>Facebook</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#twitter"><strong>12.3</strong><span>Twitter</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#cas"><strong>12.4</strong><span>CAS (Central Authentication Service)</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="oauth">12 Delegating authentication to OAuth providers</h1>
This plugin is meant to be used in applications serving a REST API's to pure Javascript clients. The main authentication
flow of this plugin is to allow you to authenticate your users against any Spring Security-compatible user directory
(like a DB or an LDAP server).<p class="paragraph"/>However, there might be situations where you want to delegate the authentication against a third-party provider, like
Google or Facebook. Unfortunately, your pure Javascript front-end application cannot request the providers directly using
OAuth, because then the access keys will be made public.<p class="paragraph"/>So is this plugin's responsibility to provide endpoints so your Grails backend acts as a proxy for your front-end client.<p class="paragraph"/>The flow is something like the following:<p class="paragraph"/><img border="0" class="center" src="../img/oauth.png"></img>
<ol>
<li>The client application requests and endpoint that requires authentication, so the server responds with a 401 response (*).</li>
<li>The client redirects the user to the login form (*).</li>
<li>This time, instead of using username and password, the user clicks on "Login with Google" button.</li>
<li>Browser navigates to a Grails URL. Grails will generate a Google Login URL, giving Google a Grails callback URL.</li>
<li>Browser navigates to Google Login. User logs in, and Google redirects the browser to the Grails callback URL.</li>
<li>Browser navigates to that Grails callback URL. Then, Grails will use OAuth to fetch user information (like email) from Google. Based on that, will generate a REST API token and fetch and store principal information. The response from Grails will be a front-end URL where the token is a parameter.</li>
<li>The browser will navigate to that URL, and the Javascript logic will read the token from the URL and store it locally.</li>
<li>The client sends again a request to the protected resource, passing the token as an HTTP header (*).</li>
</ol><p class="paragraph"/>The steps flagged with (*) remain unchanged from the <a href="../guide/single.html#authentication" class="guide">normal flow</a>.<p class="paragraph"/>The Grails callback URL mentioned above has this general format: <code>${grails.serverURL}/oauth/callback/${providerName}</code>.
You will need to configure such URL in your OAuth 2.0 provider.<p class="paragraph"/>To support OAuth, this plugin uses <a href="https://github.com/leleuj/pac4j" target="blank">Profile &#38; Authentication Client for Java</a>. So you
can use any OAuth 2.0 provider they support. This includes at the time of writing:
<ul class="star">
<li>Dropbox.</li>
<li>Facebook.</li>
<li>GitHub.</li>
<li>Google.</li>
<li>LinkedIn.</li>
<li>Windows Live.</li>
<li>Wordpress.</li>
<li>Yahoo.</li>
<li>Paypal.</li>
</ul><p class="paragraph"/>Note that OAuth 1.0a providers also work, like Twitter.<p class="paragraph"/>If your provider is not supported by pac4j, you can write your own. Please refer to the
<a href="https://github.com/pac4j/pac4j/wiki/Clients#creating-your-own-client" target="blank">pac4j documentation</a> for that.<p class="paragraph"/>The plugin also supports <a href="https://www.apereo.org/projects/cas" target="blank">CAS (Central Authentication Service)</a> using the OAuth
authentication flow.  See <a href="../guide/single.html#cas" class="guide">CAS Authentication</a> for details.<p class="paragraph"/>To start the OAuth authentication flow, from your frontend application, generate a link to
<code>&#60;YOUR_GRAILS_APP&#62;/oauth/authenticate/&#60;provider&#62;</code>. The user clicking on that link represents step 4 in the previous
diagram.<p class="paragraph"/>Note that you can define the frontend callback URL in <code>Config.groovy</code> under
<code>grails.plugin.springsecurity.rest.oauth.frontendCallbackUrl</code>.<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.<span class="java&#45;keyword">rest</span>.oauth.frontendCallbackUrl = <span class="java&#45;quote">"http://my.frontend&#45;app.com/welcome&#35;token="</span></pre></div><p class="paragraph"/>The token will be concatenated to the end of the URL.<p class="paragraph"/><blockquote class="note">
For backwards compatibility with versions 1.5.2 and earlier, the callback URL can also be defined as a closure that will
be called with the token value as a parameter:<p class="paragraph"/>    <div class="code"><pre>grails.plugin.springsecurity.<span class="java&#45;keyword">rest</span>.oauth.frontendCallbackUrl = &#123; <span class="java&#45;object">String</span> tokenValue &#45;&#62; <span class="java&#45;quote">"http://my.frontend&#45;app.com/welcome&#35;token=$&#123;tokenValue&#125;"</span> &#125;</pre></div>
</blockquote><p class="paragraph"/>You can also define the URL as a <code>callback</code> parameter in the original link, eg:<p class="paragraph"/><div class="code"><pre>http://your&#45;grails&#45;api.com/oauth/authenticate/google?callback=http://your&#45;frontend&#45;app.com/auth&#45;success.html?token=</pre></div><p class="paragraph"/>Upon successful OAuth authorisation (after step 6.1 in the above diagram), an
<a href="http://alvarosanchez.github.io/grails-spring-security-rest/latest/docs/gapi/grails/plugin/springsecurity/rest/oauth/OauthUser.html" target="blank">OauthUser</a>
will be stored in the security context. This is done by a bean named <code>oauthUserDetailsService</code>. The
<a href="http://alvarosanchez.github.io/grails-spring-security-rest/latest/docs/gapi/grails/plugin/springsecurity/rest/oauth/DefaultOauthUserDetailsService.html" target="blank">default implementation</a>
delegates to the configured <code>userDetailsService</code> bean, passing the profile ID as the username:<p class="paragraph"/><div class="code"><pre>/&#42;&#42;
 &#42; Builds an &#123;<code>link OauthUser&#125;. Delegates to the <span class="java&#45;keyword">default</span> &#123;</code>link UserDetailsService&#35;loadUserByUsername(java.lang.<span class="java&#45;object">String</span>)&#125;
 &#42; where the username passed is &#123;@link UserProfile&#35;getId()&#125;. If the user is not found, it will create a <span class="java&#45;keyword">new</span> one with
 &#42; the the <span class="java&#45;keyword">default</span> roles.
 &#42;/
@Slf4j
class DefaultOauthUserDetailsService <span class="java&#45;keyword">implements</span> OauthUserDetailsService &#123;<p class="paragraph"/>    @Delegate
    UserDetailsService userDetailsService<p class="paragraph"/>    UserDetailsChecker preAuthenticationChecks<p class="paragraph"/>    OauthUser loadUserByUserProfile(CommonProfile userProfile, Collection&#60;GrantedAuthority&#62; defaultRoles)
            <span class="java&#45;keyword">throws</span> UsernameNotFoundException &#123;
        UserDetails userDetails
        OauthUser oauthUser<p class="paragraph"/>        <span class="java&#45;keyword">try</span> &#123;
            log.debug <span class="java&#45;quote">"Trying to fetch user details <span class="java&#45;keyword">for</span> user profile: $&#123;userProfile&#125;"</span>
            userDetails = userDetailsService.loadUserByUsername userProfile.id<p class="paragraph"/>            log.debug <span class="java&#45;quote">"Checking user details with $&#123;preAuthenticationChecks.class.name&#125;"</span>
            preAuthenticationChecks?.check(userDetails)<p class="paragraph"/>            Collection&#60;GrantedAuthority&#62; allRoles = userDetails.authorities + defaultRoles
            oauthUser = <span class="java&#45;keyword">new</span> OauthUser(userDetails.username, userDetails.password, allRoles, userProfile)
        &#125; <span class="java&#45;keyword">catch</span> (UsernameNotFoundException unfe) &#123;
            log.debug <span class="java&#45;quote">"User not found. Creating a <span class="java&#45;keyword">new</span> one with <span class="java&#45;keyword">default</span> roles: $&#123;defaultRoles&#125;"</span>
            oauthUser = <span class="java&#45;keyword">new</span> OauthUser(userProfile.id, 'N/A', defaultRoles, userProfile)
        &#125;<p class="paragraph"/>        <span class="java&#45;keyword">return</span> oauthUser
    &#125;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>
If you want to provide your own implementation, define it in <code>resources.groovy</code> with bean name <code>oauthUserDetailsService</code>.
Make sure you implements the interface <code>OauthUserDetailsService</code><p class="paragraph"/>If you want to do any additional post-OAuth authorisation check, you should do it on your <code>loadUserByUserProfile</code>
implementation. This is useful if you want to allow your corporate users to log into your application using their Gmail
account. In this case, you should decide based on OAuth20Profile.getEmail(), for instance:<p class="paragraph"/><div class="code"><pre>OauthUser loadUserByUserProfile(OAuth20Profile userProfile, Collection&#60;GrantedAuthority&#62; defaultRoles) <span class="java&#45;keyword">throws</span> UsernameNotFoundException &#123;
    <span class="java&#45;keyword">if</span> (userProfile.email.endsWith('example.org')) &#123;
        <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">new</span> OauthUser(userProfile.id, 'N/A', defaultRoles, userProfile)
    &#125; <span class="java&#45;keyword">else</span> &#123;
        <span class="java&#45;keyword">throw</span> <span class="java&#45;keyword">new</span> UsernameNotFoundException(<span class="java&#45;quote">"User with email $&#123;userProfile.email&#125; now allowed. Only @example.org accounts are allowed."</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/><h3>Error Handling</h3><p class="paragraph"/>In case of any OAuth authentication failure, the plugin will redirect back to the frontend application so it
can render an error message and/or offer the user the option to try again. When an error occurs, the token
parameter will be empty, and error parameters will be appended to the callback URL e.g.<p class="paragraph"/><div class="code"><pre>http://your&#45;frontend&#45;app.com/auth&#45;success.html?token=&#38;error=403&#38;message=User+with+email+jimmy%40gmail.com+now+allowed&#38;error_description=User+with+email+jimmy%40gmail.com+not+allowed&#38;error_code=UsernameNotFoundException</pre></div><p class="paragraph"/>A description of each error parameter is given below
<ul class="star">
<li><code>error</code> - a code describing the error. This parameter is required by <a href="https://tools.ietf.org/html/rfc6749" target="blank">RFC 6749</a></li>
<li><code>error_description</code> - a human readable message describing the error. This parameter is optional according to <a href="https://tools.ietf.org/html/rfc6749" target="blank">RFC 6749</a></li>
<li><code>message</code> - the value of this parameter will be identical to <code>error_description</code>, it is provided only for backwards compatability with versions 1.5.2 and earlier which omitted <code>error_description</code></li>
<li><code>error_code</code> - the value of this parameter will be simple name of the exception that caused the error</li>
</ul><p class="paragraph"/>The error handling described above is implemented by a Spring bean named <code>callbackErrorHandler</code>. This behaviour can be customised
by providing a replacement bean of the same name that implements this interface<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">interface</span> CallbackErrorHandler &#123;<p class="paragraph"/>    /&#42;&#42;
     &#42; Converts an error that occurs during the callback to a parameter map that will be returned to the frontend
     &#42; @param cause
     &#42; @<span class="java&#45;keyword">return</span>
     &#42;/
    Map convert(Exception cause)
&#125;</pre></div><p class="paragraph"/>It is strongly recommended (but not enforced by the plugin) that you include in the returned <code>Map</code> any parameters required by <a href="https://tools.ietf.org/html/rfc6749" target="blank">RFC 6749</a><p class="paragraph"/>The following sections provide examples of how to configure the plugin for usage with some popular OAuth providers: Google, Facebook and Twitter.



<h2 id="google">12.1 Google</h2>
Define the following block in your <code>Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails &#123;
    plugin &#123;
        springsecurity &#123;<p class="paragraph"/>            <span class="java&#45;keyword">rest</span> &#123;<p class="paragraph"/>                oauth &#123;<p class="paragraph"/>                    frontendCallbackUrl = &#123; <span class="java&#45;object">String</span> tokenValue &#45;&#62; <span class="java&#45;quote">"http://my.frontend&#45;app.com/welcome&#35;token=$&#123;tokenValue&#125;"</span> &#125;<p class="paragraph"/>                    google &#123;<p class="paragraph"/>                        client = org.pac4j.oauth.client.Google2Client
                        key = 'xxxx.apps.googleusercontent.com'
                        secret = 'xxx'
                        scope = org.pac4j.oauth.client.Google2Client.Google2Scope.EMAIL_AND_PROFILE
                        defaultRoles = &#91;'ROLE_USER', 'ROLE_GOOGLE'&#93;<p class="paragraph"/>                    &#125;
                &#125;
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="warning">
The <code>scope</code> can be from any value of the enum <code>org.pac4j.oauth.client.Google2Client.Google2Scope</code>. But if you use the
default <code>OauthUserDetailsService</code>, you need to use <code>EMAIL_AND_PROFILE</code>. That is because the default implementation
uses the profile ID as the username, and that is only returned by Google if <code>EMAIL_AND_PROFILE</code> scope is used.
</blockquote>



<h2 id="facebook">12.2 Facebook</h2>
Define the following block in your <code>Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails &#123;
    plugin &#123;
        springsecurity &#123;<p class="paragraph"/>            <span class="java&#45;keyword">rest</span> &#123;<p class="paragraph"/>                oauth &#123;<p class="paragraph"/>                    frontendCallbackUrl = &#123; <span class="java&#45;object">String</span> tokenValue &#45;&#62; <span class="java&#45;quote">"http://my.frontend&#45;app.com/welcome&#35;token=$&#123;tokenValue&#125;"</span> &#125;<p class="paragraph"/>                    facebook &#123;<p class="paragraph"/>                        client = org.pac4j.oauth.client.FacebookClient
                        key = 'xxx'
                        secret = 'yyy'
                        scope = 'email,user_location'
                        fields = 'id,name,first_name,middle_name,last_name,username'
                        defaultRoles = &#91;'ROLE_USER', 'ROLE_FACEBOOK'&#93;
                    &#125;
                &#125;
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>The <code>scope</code> is a comma-separated list, <strong class="bold">without blanks</strong>, of Facebook permissions. See the
<a href="https://developers.facebook.com/docs/reference/login/" target="blank">Facebook documentation</a> for more details.<p class="paragraph"/><code>fields</code> may contain a comma-separated list, <strong class="bold">without blanks</strong>, of
<a href="https://developers.facebook.com/docs/graph-api/reference/user/" target="blank">user fields</a>.<p class="paragraph"/>Both <code>scope</code> and <code>fields</code> are optional, but it's highly recommendable to fine tune those lists so you don't ask for
information you don't need.


<h2 id="twitter">12.3 Twitter</h2>
Define the following block in your <code>Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails &#123;
    plugin &#123;
        springsecurity &#123;<p class="paragraph"/>            <span class="java&#45;keyword">rest</span> &#123;<p class="paragraph"/>                oauth &#123;<p class="paragraph"/>                    frontendCallbackUrl = &#123; <span class="java&#45;object">String</span> tokenValue &#45;&#62; <span class="java&#45;quote">"http://my.frontend&#45;app.com/welcome&#35;token=$&#123;tokenValue&#125;"</span> &#125;<p class="paragraph"/>                    twitter &#123;<p class="paragraph"/>                        client = org.pac4j.oauth.client.TwitterClient
                        key = 'xxx'
                        secret = 'yyy'
                        defaultRoles = &#91;'ROLE_USER', 'ROLE_TWITTER'&#93;
                    &#125;
                &#125;
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>There is no additional configuration for Twitter.


<h2 id="cas">12.4 CAS (Central Authentication Service)</h2>
Define the following block in your <code>Config.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails &#123;
    plugin &#123;
        springsecurity &#123;<p class="paragraph"/>            <span class="java&#45;keyword">rest</span> &#123;<p class="paragraph"/>                oauth &#123;<p class="paragraph"/>                    frontendCallbackUrl = &#123; <span class="java&#45;object">String</span> tokenValue &#45;&#62; <span class="java&#45;quote">"http://my.frontend&#45;app.com/welcome&#35;token=$&#123;tokenValue&#125;"</span> &#125;<p class="paragraph"/>                    cas &#123;<p class="paragraph"/>                        client = org.pac4j.cas.client.CasClient
                        casLoginUrl = <span class="java&#45;quote">"https://my.cas&#45;server.com/cas/login"</span>
                    &#125;
                &#125;
            &#125;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Set <code>casLoginUrl</code> to the login URL of your CAS server.



                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/cors.html">&lt;&lt; <strong>11</strong><span>CORS support</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/debugging.html"><strong>13</strong><span>Debugging</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
